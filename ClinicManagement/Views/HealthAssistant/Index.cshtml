@{
    ViewBag.Title = "Health Assistant";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-md-12">
        <div class="x_panel">
            <div class="x_title">
                <h2><i class="fa fa-comments"></i> Health Assistant <small>AI-Powered Medical Assistant</small></h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="row">
                    <div class="col-md-8">
                        <div class="chat-container">
                            <div id="chat-messages" class="chat-messages">
                                <div class="message assistant">
                                    <div class="message-avatar">
                                        <i class="fa fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        <div class="message-header">
                                            <span class="name">Health Assistant</span>
                                            <span class="time">@DateTime.Now.ToString("HH:mm")</span>
                                        </div>
                                        <div class="message-text">
                                            Hello! I am your AI health assistant. How can I help you today?
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <div class="input-group">
                                    <input type="text" id="message-input" class="form-control" placeholder="Type your medical question here...">
                                    <span class="input-group-btn">
                                        <button class="btn btn-primary" id="send-button" type="button">
                                            <i class="fa fa-paper-plane"></i> Send
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2>How to Use</h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <div class="dashboard-widget-content">
                                    <ul class="quick-list">
                                        <li><i class="fa fa-check-circle"></i> Ask medical questions</li>
                                        <li><i class="fa fa-check-circle"></i> Get symptom information</li>
                                        <li><i class="fa fa-check-circle"></i> Learn about medications</li>
                                        <li><i class="fa fa-check-circle"></i> Receive general health advice</li>
                                    </ul>
                                    <div class="alert alert-info" role="alert">
                                        <i class="fa fa-info-circle"></i> Note: This AI assistant provides general information only. Always consult with a healthcare professional for medical advice.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const chatMessages = $('#chat-messages');
            const messageInput = $('#message-input');
            const sendButton = $('#send-button');

            function getCurrentTime() {
                return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            }

            function addMessage(content, isUser) {
                const time = getCurrentTime();
                const messageHtml = `
                    <div class="message ${isUser ? 'user' : 'assistant'}">
                        <div class="message-avatar">
                            <i class="fa fa-${isUser ? 'user' : 'robot'}"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="name">${isUser ? 'You' : 'Health Assistant'}</span>
                                <span class="time">${time}</span>
                            </div>
                            <div class="message-text">${content}</div>
                        </div>
                    </div>
                `;
                chatMessages.append(messageHtml);
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }

            function sendMessage() {
                const message = messageInput.val().trim();
                if (message) {
                    addMessage(message, true);
                    messageInput.val('').focus();
                    
                    // Disable input and button while processing
                    messageInput.prop('disabled', true);
                    sendButton.prop('disabled', true);

                    $.ajax({
                        url: '@Url.Action("SendMessage", "HealthAssistant")',
                        type: 'POST',
                        data: { message: message },
                        success: function (response) {
                            if (response.success) {
                                const parsedResponse = JSON.parse(response.response);
                                const assistantMessage = parsedResponse.choices[0].message.content;
                                addMessage(assistantMessage, false);
                            } else {
                                addMessage('Sorry, an error occurred. Please try again.', false);
                            }
                        },
                        error: function () {
                            addMessage('Sorry, an error occurred. Please try again.', false);
                        },
                        complete: function() {
                            // Re-enable input and button after processing
                            messageInput.prop('disabled', false);
                            sendButton.prop('disabled', false);
                            messageInput.focus();
                        }
                    });
                }
            }

            sendButton.click(sendMessage);
            messageInput.keypress(function (e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Focus input on page load
            messageInput.focus();
        });
    </script>
} 